server {
    listen		443 ssl;
    server_name		observation.org beta.observation.org beta-acc.observation.org beta-test.observation.org;
    ssl_certificate	/etc/nginx/ssl/observation_org-chained.crt;
    ssl_certificate_key	/etc/nginx/ssl/observation_org.key;
    include include/pfs.conf;

    #include include/block_ip.conf;

    location @uwsgi {
    uwsgi_pass  unix:///var/uwsgi/obs.socket;
        include uwsgi_params;
    }

    location / {
        if ($request_method = POST) { return 404; }
        if ($http_cookie ~* "no_fpc") { return 404; }
        default_type  "text/html; charset=utf-8";
        set $memcached_key "fpc:$scheme://$host$request_uri";
        memcached_pass localhost:11211;
        error_page     404 405 502 504 = @uwsgi;
    }

    location /robots.txt {
    alias /home/obs/static/robots.txt;
    }

    location /favicon.ico {
    alias /home/obs/static/img/icon/favicon.ico;
    }

    location /static/ {
    alias /home/obs/static/;
    }

    location /media/ {
    alias /home/obs/media/;
    }

    # PHP for /pda/
    location ~ ^/_router\.php$ { 
        alias    /home/waarneming/www/;
        include include/php_long.conf;
    }
    location /pda/ {
        alias    /home/waarneming/www/;
        location ~ /\.  { deny all; }
        client_max_body_size    50M;
        ## rewrite /index.php to / and do the opposite for the mobile site
        #if ($host !~* "^m\..+") { rewrite ^/index.php(.*)$ /$1 permanent; }
        if ($host ~* "^m\..+")          { rewrite ^/$ /index.php permanent; }
        ## add index.php to directories with a slash
        if ($request_uri ~ "(.+)/$")    { rewrite ^(.*)$ $1index.php permanent; }
        if ($request_uri ~ "^/$")       { rewrite ^ /_router.php; }
        if ($request_uri ~ "^/\?")      { rewrite ^ /_router.php; }
        if ($uri ~ \.php$)              { set $router true; }
        if (!-e $request_filename)      { set $router true; }
        if ($router)                    { rewrite ^ /_router.php; }
    }

}

server {
    listen 80;
    server_name		beta.observation.org beta-acc.observation.org beta-test.observation.org;
    rewrite ^ https://$host$request_uri? permanent;
}
